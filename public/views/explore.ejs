<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OCM || Explore</title>
  <meta name="robots" content="noindex, follow" />
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="theme-style-mode" content="0"> <!-- 0 == light, 1 == dark -->

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.png">
  <!-- CSS 
	============================================ -->
  <link rel="stylesheet" href="assets/css/vendor/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/vendor/slick.css">
  <link rel="stylesheet" href="assets/css/vendor/slick-theme.css">
  <link rel="stylesheet" href="assets/css/vendor/nice-select.css">
  <link rel="stylesheet" href="assets/css/plugins/feature.css">
  <link rel="stylesheet" href="assets/css/plugins/jquery-ui.min.css">
  <script src="//cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <!-- Style css -->
  <link rel="stylesheet" href="assets/css/style.css">

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <% include ('functions.ejs') %>
</head>

<body class="template-color-1">
  <!-- start header area -->
  <!-- Preloader -->
  <div class="preloader">
    <div class='loader'>
      <div class='circle'></div>
      <div class='circle'></div>
      <div class='circle'></div>
      <div class='circle'></div>
      <div class='circle'></div>
    </div>
  </div>

  <%- include('sections/header.ejs') -%>

  <!-- Start product area -->
  <div class="rn-product-area rn-section-gapTop">
    <div class="container">
      <div class="row mb--50 align-items-center">
        <div class="col-lg-6 col-md-6 col-sm-6 col-12">
          <h3 class="title mb--0" data-sal-delay="150" data-sal="slide-up" data-sal-duration="800">Explore Product</h3>
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6 col-12 mt_mobile--15">
          <div class="view-more-btn text-start text-sm-end" data-sal-delay="150" data-sal="slide-up" data-sal-duration="800">
            <button class="discover-filter-button discover-filter-activation btn btn-primary">Filter<i class="feather-filter"></i></button>
          </div>
        </div>
      </div>

      <div class="default-exp-wrapper default-exp-expand">
        <div class="inner">
          <div class="filter-select-option">
            <label class="filter-leble">Likes</label>
            <select id="sort-likes">
              <option data-display="Likes" value='' class="option disabled" selected disabled>Likes</option>
              <option value=-1 id="mostLiked">Most liked</option>
              <option value=1 id="leastLiked">Least liked</option>
            </select>
          </div>
          <div class="filter-select-option">
            <label class="filter-leble">Price</label>
            <select id="sort-price">
              <option data-display="Price" value='' class="option disabled" selected disabled>Price</option>
              <option value=1 id="priceLH">Low to High</option>
              <option value=-1 id="priceHL">High to Low</option>
            </select>
          </div>
          <div class="filter-select-option">
            <label class="filter-leble">Extras</label>
            <select id="filter-extras">
              <option data-display="Select Option" value='' selected disabled>Select Option</option>
              <option value="Verified" id="verifiedOption">Verified</option>
              <option value="Staykable" id="staykableOption">Staykable</option>
            </select>
          </div>
          <div class="filter-select-option">
            <label class="filter-leble">Brand</label>
            <select id="filter-brands">
              <option data-display="Select Brand" class="option disabled" value='' selected disabled>Select Brand</option>
              <% filterOptions.forEach(function(res){%>
              <option value="<%=res.issuers%>" id="<%=res.issuers%>"><%=res._id%></option>
              <%}); %>
            </select>
          </div>
          <div class="filter-select-option">
            <label class="filter-leble">Family</label>
            <select id="filter-family">
              <option data-display="Select Family" value='' selected disabled>Select Family</option>
            </select>
          </div>
          <div class="filter-select-option">
            <label class="filter-leble">Collection</label>
            <select id="filter-collection">
              <option data-display="Select Collection" value='' selected disabled>Select Collection</option>
            </select>
          </div>
          <!--Print here other filter options upon MongoDB query in relation to selected brand-->


          <div class="filter-select-option">
            <label class="filter-leble">Price Range (XRP)</label>
            <div class="price_filter s-filter clear">
              <form action="#" method="GET">
                <div class="slider__range--output">
                  <div class="price-filter-input-wrap">
                    <input id="filter-price-min" type="number" placeholder="min" max="999999">
                    <input id="filter-price-max" type="number" placeholder="max" max="1000000">
                  </div>
                  <div class="price__output--wrap">
                    <div class="price--filter">

                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <div class="filter-select-option">
            <a class="btn btn-primary mr--10" onclick="handleFilterSort()">Apply Filter</a>
            <a class="btn btn-secondary btn-small" href="/explore?page=0">Reset Filters</a>
          </div>
        </div>
      </div>
      <%- include ("models/nft-rows.ejs", {nfts:nfts}) %>
      <nav class="pagination-wrapper" aria-label="Page navigation example">
      </nav>
      <!-- <%#- include ("models/pagination.ejs" , {page:page, queries:queries}) %> -->
    </div>
  </div>
  <!-- end product area -->
  <!-- Modal require -->
  <%- include('sections/popup-modal.ejs') -%>

  <%- include('sections/footer.ejs') -%>
  <!-- Start Top To Bottom Area  -->
  <div class="rn-progress-parent">
    <svg class="rn-back-circle svg-inner" width="100%" height="100%" viewBox="-1 -1 102 102">
      <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
    </svg>
  </div>
  <!-- End Top To Bottom Area  -->
  <!-- JS ============================================ -->
  <script src="assets/js/vendor/jquery.js"></script>
  <script src="assets/js/vendor/jquery.nice-select.min.js"></script>
  <script src="assets/js/vendor/jquery-ui.js"></script>
  <script src="assets/js/vendor/modernizer.min.js"></script>
  <script src="assets/js/vendor/feather.min.js"></script>
  <script src="assets/js/vendor/slick.min.js"></script>
  <script src="assets/js/vendor/bootstrap.min.js"></script>
  <script src="assets/js/vendor/sal.min.js"></script>
  <script src="assets/js/vendor/waypoint.js"></script>
  <script src="assets/js/vendor/wow.js"></script>
  <script src="assets/js/vendor/particles.js"></script>
  <script src="assets/js/vendor/jquery.style.swicher.js"></script>
  <script src="assets/js/vendor/js.cookie.js"></script>
  <script src="assets/js/vendor/count-down.js"></script>
  <script src="assets/js/vendor/counter-up.js"></script>
  <script src="assets/js/vendor/isotop.js"></script>
  <script src="assets/js/vendor/imageloaded.js"></script>
  <script src="assets/js/vendor/backtoTop.js"></script>
  <script src="assets/js/vendor/scrolltrigger.js"></script>
  <script src="assets/js/vendor/jquery.custom-file-input.js"></script>
  <script src="assets/js/vendor/savePopup.js"></script>
  <!-- main JS -->
  <script src="assets/js/main.js"></script>
  <script>
    var iteration = 1;
    var filterOptions = <%- JSON.stringify(filterOptions) %>;
    console.log(filterOptions)
    $(window).on('load', function () {
      var url = (new URL(location.href)).searchParams;
      const s = 'selected';
      if (url.get('sortLikes')) {
        var srtL = url.get('sortLikes')
        if (srtL == -1) {
          $('#mostLiked').attr(s, s)
        } else if (srtL == 1) {
          $('#leastLiked').attr(s, s)
        }
      }
      if (url.get('sortPrice')) {
        var sP = url.get('sortPrice')
        if (sP == 1) {
          $('#priceLH').attr(s,s)
        } else if (sP == -1) {
          $('#priceHL').arrt(s,s)
      	}
      }
      if (url.get('filterExtras')) {
        var fE = url.get('filterExtras')
        if (fE == 'Verified') {
          $('#verifiedOption').attr(s,s)
        } else if (fE == 'Staykable') {
          $('#staykableOption').attr(s,s)
        }
      }
      if (url.get('filterBrands')) {
        var fB = url.get('filterBrands')
        for (filter of filterOptions){
          if (fB == filter.issuers[0]) {
            $(`#${filter.issuers[0]}`).attr(s,s)
          }
        }
      }
      $('select').niceSelect('update');
    })
    $('#filter-brands').change(function() {
      var val = $('#filter-brands').val();
      $('#filter-family').empty();
      $('#filter-collection').empty();
      for (var i = 0; i < filterOptions.length; i++) {
        if (val == filterOptions[i].issuers) {
          $('#filter-family').append(`<option data-display="Select Family" value='' selected disabled>Select Family</option>`);
          $('#filter-collection').append(`<option data-display="Select Collection" value='' selected disabled>Select Collection</option>`);
          for (var fam = 0; fam < filterOptions[i].familyFilters.length; fam++) {
            $('#filter-family').append(`<option value="${filterOptions[i].familyFilters[fam]}">${filterOptions[i].familyFilters[fam]}</option>`);
          }
          for (var col = 0; col < filterOptions[i].nameFilters.length; col++) {
            $('#filter-collection').append(`<option value="${filterOptions[i].nameFilters[col]}">${filterOptions[i].nameFilters[col]}</option>`);
          }
        }
      }
      $('select').niceSelect('update');
    });

    function handleFilterSort() {
      var url = urlFilterConstructor();
      window.location.href = url;
    }

    function urlFilterConstructor() {
      const jsonFilterSort = {
        sortLikes: document.getElementById("sort-likes").value,
        sortPrice: document.getElementById("sort-price").value,
        filterExtras: document.getElementById("filter-extras").value,
        filterBrands: document.getElementById("filter-brands").value,
        filterFamilies: document.getElementById("filter-family").value,
        filterCollections: document.getElementById("filter-collection").value,
        filterPriceMin: document.getElementById("filter-price-min").value,
        filterPriceMax: document.getElementById("filter-price-max").value
      }
      var url = `?markerIteration=${iteration}`;
      if (jsonFilterSort.sortLikes)
        url += `&sortLikes=${jsonFilterSort.sortLikes}`;
      if (jsonFilterSort.sortPrice)
        url += `&sortPrice=${jsonFilterSort.sortPrice}`;
      if (jsonFilterSort.filterExtras)
        url += `&filterExtras=${jsonFilterSort.filterExtras}`;
      if (jsonFilterSort.filterBrands)
        url += `&filterBrands=${jsonFilterSort.filterBrands}`;
      if (jsonFilterSort.filterFamilies)
        url += `&filterFamilies=${jsonFilterSort.filterFamilies}`;
      if (jsonFilterSort.filterCollections)
        url += `&filterCollections=${jsonFilterSort.filterCollections}`;
      if (jsonFilterSort.filterPriceMin)
        url += `&filterPriceMin=${jsonFilterSort.filterPriceMin}`;
      if (jsonFilterSort.filterPriceMax)
        url += `&filterPriceMax=${jsonFilterSort.filterPriceMax}`;
      return url;
    }
    $(window).data('getReady', true).scroll(function(e) {
      if ($(window).data('getReady') == false) return;
      if (($(".row.g-5").offset().top + $(".row.g-5").height()*0.85 - $(window).height()) < $(this).scrollTop()) {
        $(window).data('getReady', false);

        $.get(`<%=url%>/get-additional-explore-nfts${urlFilterConstructor()}`,
          function(data) {
            if (data == 'empty'){
              $('.pagination-wrapper').html('No more NFTs found')
            } else {
              iteration++;
              $("#exploreSection").append(data)
              const cardsUnlisted = document.getElementById("exploreSection").querySelectorAll(".col-5");
              cardsUnlisted.forEach(element => {
                element.classList.add("sal-animate")
              });
              $(window).data('getReady', true);
            }
          }
        )

      }
    })
  </script>

</html>